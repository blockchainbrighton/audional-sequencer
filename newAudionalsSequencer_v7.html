<!DOCTYPE html>
<html>
<head>
<style>
:root{--main-bg-color:#000;--secondary-bg-color:#333;--primary-color:#fff;--accent-color:red;--play-button-dimension:50px;--stop-button-dimension:50px;--step-button-dimension:25px;--control-button-dimension:25px;--box-shadow-style:0 0 10px var(--main-bg-color) inset;--default-font:Arial,sans-serif;--green:#0f0;--red:red;--grey:#555;--white:#fff;--border-radius:5px}body{background-color:var(--main-bg-color);color:var(--primary-color);font:normal normal normal 100%/1 var(--default-font)}#drum-machine{width:80%;margin:0 auto;padding:20px;background-color:var(--secondary-bg-color);border:5px solid var(--main-bg-color)}h1{text-align:center;display:flex;justify-content:space-between;align-items:center;position:relative}.button{border:none;border-radius:var(--border-radius);background-color:var(--primary-color);cursor:pointer;box-shadow:var(--box-shadow-style)}h1 .button{padding:10px;color:var(--main-bg-color);font-size:1em}.step-button{margin-top:10px;height:10px;background-color:var(--grey);color:var(--white)}
.control-button,.play-button,.stop-button{width:var(--control-button-dimension);height:var(--control-button-dimension)}.play-button{width:var(--play-button-dimension);height:var(--play-button-dimension)}#play.selected{background-color:var(--green)}.button-label{color:var(--green)}.stop-button{width:var(--stop-button-dimension);height:var(--stop-button-dimension)}.button-label.stop{color:var(--red)}#stop.selected~#play{background-color:var(--primary-color)}.stop-button:active,.stop-button.selected{background-color:var(--accent-color)}.channel,.button-container{position:relative;display:flex;align-items:center;justify-content:space-between}.steps-container,.channel-controls{display:flex;justify-content:center;flex-wrap:wrap;gap:0px;margin:0}.controls-container{width:15%;gap:5px;display:flex;flex-direction:column;align-items:flex-end}.title{font-size:40px}#play,#play.selected,#stop.selected~#play{animation:flash 2s infinite ease-in-out}.step-button:active,.step-button.selected,.mute-button.selected{background-color:var(--accent-color)}
.step-button.playing{box-shadow:0 0 10px #969696 inset}.step-button.playing.selected{box-shadow:0 0 10px #960101 inset}.channel-controls{margin-top:20px}.clear-button{background-color:#ff0}.mute-button{background-color:#800}.load-sample-button,.clear-button,.mute-button{flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:.8em}.load-sample-button:hover:after{content:attr(title);position:absolute;background:var(--primary-color);color:var(--main-bg-color);padding:5px;border-radius:var(--border-radius);z-index:1}#load-preset{font-size:1em;padding:5px 10px}.load-sample-button.loaded{width:calc(100%*1.25)}.step-button:nth-child(16n+1){background-color:#ff0}.step-button:nth-child(4n+1):not(:nth-child(16n+1)){background-color:#add8e6}.channel-container .step-button.selected{background-color:var(--red)}@keyframes flash{0%{background-color:var(--primary-color)}50%{background-color:var(--green)}100%{background-color:var(--primary-color)}}.button-label{position:relative;z-index:2}
</style>
</head>
<body>
<div id=drum-machine><h1><span class=button-label>Play</span><div class="button button-round"><div class="button play-button"id=play></div></div><span class=title>Audional JSON Sequencer (beta)</span> <span class="button-label stop">Stop</span><div class="button button-round"><div class="button stop-button"id=stop></div></div><div class=bpm-container>BPM: <input id=bpm-slider max=180 min=60 step=1 type=range value=125><div class=bpm-display id=bpm-display>125</div></div></h1><div class=channel id=bass-drum><button class=load-sample-button title="Full name of loaded file">Load New Audional</button><div><button class="control-button clear-button">C</button> <button class="control-button mute-button">M</button></div><div class=channel-container><div class=steps-container></div><div class=controls-container><div class=channel-controls><div class=button-container></div></div></div></div></div><div class=channel id=snare><button class=load-sample-button title="Full name of loaded file">Load New Audional</button><div><button class="control-button clear-button">C</button> <button class="control-button mute-button">M</button></div><div class=channel-container><div class=steps-container></div><div class=controls-container><div class=channel-controls><div class=button-container></div></div></div></div></div><div class=channel id=hi-hat><button class=load-sample-button title="Full name of loaded file">Load New Audional</button><div><button class="control-button clear-button">C</button> <button class="control-button mute-button">M</button></div><div class=channel-container><div class=steps-container></div><div class=controls-container><div class=channel-controls><div class=button-container></div></div></div></div></div><div class=channel id=bass><button class=load-sample-button title="Full name of loaded file">Load New Audional</button><div><button class="control-button clear-button">C</button> <button class="control-button mute-button">M</button></div><div class=channel-container><div class=steps-container></div><div class=controls-container><div class=channel-controls><div class=button-container></div></div></div></div></div><div class=channel id=channel-5><button class=load-sample-button title="Full name of loaded file">Load New Audional</button><div><button class="control-button clear-button">C</button> <button class="control-button mute-button">M</button></div><div class=channel-container><div class=steps-container></div><div class=controls-container><div class=channel-controls><div class=button-container></div></div></div></div></div><div class=channel id=channel-5><button class=load-sample-button title="Full name of loaded file">Load New Audional</button><div><button class="control-button clear-button">C</button> <button class="control-button mute-button">M</button></div><div class=channel-container><div class=steps-container></div><div class=controls-container><div class=channel-controls><div class=button-container></div></div></div></div></div><div class=channel id=channel-5><button class=load-sample-button title="Full name of loaded file">Load New Audional</button><div><button class="control-button clear-button">C</button> <button class="control-button mute-button">M</button></div><div class=channel-container><div class=steps-container></div><div class=controls-container><div class=channel-controls><div class=button-container></div></div></div></div></div><div class=channel id=channel-5><button class=load-sample-button title="Full name of loaded file">Load New Audional</button><div><button class="control-button clear-button">C</button> <button class="control-button mute-button">M</button></div><div class=channel-container><div class=steps-container></div><div class=controls-container><div class=channel-controls><div class=button-container></div></div></div></div></div>
<script>
  let isPlaying = false;
  let beatCount = 0;  // new bar count variable 
  let timeoutId;
  let stopClickCount = 0;
  let channels;
  let playButton = document.getElementById('play');
  let stopButton = document.getElementById('stop');
  let bpm = 125;
  let currentStep = 0;
  let audioContext;
  let currentStepTime;
  let startTime;
  let nextStepTime;
  let stepDuration;
  let gainNodes = [];

  function getIDFromURL(url) {
    const parts = url.split('/');
    return parts[parts.length - 1];
  }

  function base64ToArrayBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
  }
  

  const fetchAudio = (path, channelIndex, loadSampleButton) => {
    fetch(path)  // REMOVED .JSON EXTENSION
        .then(response => {
            if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
        const audioData = base64ToArrayBuffer(data.audioData.split(',')[1]);
        const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });
        const audioUrl = URL.createObjectURL(audioBlob);

        const channel = document.querySelector(`.channel[data-id="Channel-${channelIndex + 1}"]`);
        channel.dataset.audioData = audioUrl;
        channel.dataset.audioDataLoaded = 'true';
        if (loadSampleButton) {
            const filename = data.filename || data.fileName; // Check both properties
            loadSampleButton.textContent = filename;
            loadSampleButton.title = filename;
        }
        })
        .catch(error => {
            console.error('Fetch error for URL ' + path + ': ', error);
        });
    };


  channels = document.querySelectorAll('.channel');

  channels.forEach((channel, index) => {
    channel.dataset.id = `Channel-${index + 1}`;

    const muteButton = channel.querySelector('.mute-button');
    muteButton.addEventListener('click', () => {
            if (channel.dataset.muted === 'true') {
        // If the channel is currently muted, unmute it
                channel.dataset.muted = '';
            } else {
                // If the channel is currently unmuted, mute it
                channel.dataset.muted = 'true';
            }
            muteButton.classList.toggle('selected');
        });

    const clearButton = channel.querySelector('.clear-button');
    clearButton.addEventListener('click', () => {
      const stepButtons = channel.querySelectorAll('.step-button');
      stepButtons.forEach(button => {
        button.classList.remove('selected');
      });
    });

    const stepsContainer = channel.querySelector('.steps-container');
    stepsContainer.innerHTML = '';

    const fragment = document.createDocumentFragment();
    for (let i = 0; i < 64; i++) {
      const button = document.createElement('button');
      button.classList.add('step-button');
      button.addEventListener('click', () => {
        button.classList.toggle('selected');
      });
      fragment.appendChild(button);
    }
    stepsContainer.appendChild(fragment);

    const loadSampleButton = channel.querySelector('.load-sample-button');
    loadSampleButton.addEventListener('click', () => {
        const audionalId = prompt('Enter the ordinal ID for the Audional you want to load:');
    const audionalPath = '/content/' + getIDFromURL(audionalId) //REMOVED JSON EXTENSION
        fetchAudio(audionalPath, index, loadSampleButton);
    });
  });

  if (playButton && stopButton) {
    const channel1 = document.querySelector('#channel-0 .step-button:nth-child(4n+1)');
    if (channel1) channel1.classList.add('selected');

    const channel2Beat1 = document.querySelector('#channel-1 .step-button:nth-child(1)');
    if (channel2Beat1) channel2Beat1.classList.add('selected');

    const channel2Beat6 = document.querySelector('#channel-1 .step-button:nth-child(6)');
    if (channel2Beat6) channel2Beat6.classList.add('selected');

    playButton.addEventListener('click', () => {
      if (!isPlaying) {
        startScheduler();
        playButton.classList.add('selected');
        stopButton.classList.remove('selected');
        isPlaying = true;
      }
    });

    stopButton.addEventListener('click', () => {
        if (isPlaying) {
            stopScheduler();
            stopButton.classList.add('selected');
            playButton.classList.remove('selected');
            isPlaying = false;
            beatCount = 0;  // reset the bar count
            currentStep = 0;  // reset the step count
            resetStepLights();  // reset the step lights
        }
        });
  } else {
    console.error("Play or Stop button is not defined");
  }


  const bpmSlider = document.getElementById('bpm-slider');
  const bpmDisplay = document.getElementById('bpm-display');
  bpmSlider.addEventListener('input', () => {
    bpm = bpmSlider.value;
    bpmDisplay.textContent = bpm;
  });

  const presets = {
    preset1: {
        urls: [
        'content/6d962189218b836cf33e2dc1adbc981e90242aa395f0868178773065f76f144ei0', // REMOVED .JSON EXTENSIONS
        'content/0b8eff3f39f4095d0f129bb8dd75f29159f8725c7e66046bf41f70ebb9f60d93i0', 
        'content/6d8be8186e63b4557e51edd66184a567bc6f5f9f5ba4bb34ba8c67e652c1934ei0', 
        'content/6c01b1214fc4d4016d683380d066849e6bc645276b102604c098bd35fd77f791i0' 
        ],
        triggers: [
        ['1', '5', '9', '13', '17', '21', '25', '29', '33', '37', '41', '45', '49', '53', '57', '61'],
        ['1', '7', '33', '39'],
        ['62'],
        ['5', '13', '21', '29', '37', '45', '53', '61', '64']
        ],
        muted: [false, false, true, true],
        unmuteBars: [null, null, 60, 32] // Use beat counts to unmute (1 beat is 4 steps)
    },
    };

  // Load a preset when the page loads
    const presetToLoadOnPageLoad = 'preset1'; // replace with the name of your preset
            if (presets[presetToLoadOnPageLoad]) {
            loadPreset(presetToLoadOnPageLoad);
            } else {
            console.error('Preset not found:', presetToLoadOnPageLoad);
            }
    
          // Function to load a preset
    function loadPreset(preset) {
    const { urls, triggers, muted } = presets[preset];
    
    // Load urls
    urls.forEach((url, index) => {
        const loadSampleButton = document.querySelector(`.channel[data-id="Channel-${index + 1}"] .load-sample-button`);
        fetchAudio(url, index, loadSampleButton);
    });

    // Set triggers
    triggers.forEach((trigger, index) => {
        trigger.forEach(pos => {
        const btn = document.querySelector(`.channel[data-id="Channel-${index + 1}"] .step-button:nth-child(${pos})`);
        if (btn) btn.classList.add('selected');
        });
    });

    // Set mute state
    muted.forEach((isMuted, index) => {
        const channel = document.querySelector(`.channel[data-id="Channel-${index + 1}"]`);
        const muteButton = channel.querySelector('.mute-button');
        channel.dataset.muted = isMuted ? 'true' : '';
        if (muteButton) {
        if (isMuted) {
            muteButton.classList.add('selected');
        } else {
            muteButton.classList.remove('selected');
        }
        }
    });
    }

    
  function setChannelVolume(channelIndex, volume) {
    const channel = document.querySelector(`.channel[data-id="Channel-${channelIndex + 1}"]`);
    channel.dataset.volume = volume;
    updateChannelVolume(channel);
    }

  function updateChannelVolume(channel) {
    const volume = parseFloat(channel.dataset.volume);
    const gainNode = gainNodes[parseInt(channel.dataset.id.split('-')[1]) - 1];
    gainNode.gain.value = volume;
    }

  function createGainNodes() {
    const audioContext = new AudioContext();
    channels.forEach(channel => {
        const gainNode = audioContext.createGain();
        gainNode.gain.value = 1; // Initial volume set to 1 (full volume)
        gainNode.connect(audioContext.destination);
        gainNodes.push(gainNode);
    });
    }

  function startScheduler() {
    audioContext = new AudioContext();
    startTime = audioContext.currentTime;
    nextStepTime = startTime;

    scheduleNextStep();
  }

  function scheduleNextStep() {
    stepDuration = 60 / bpm / 4;

    timeoutId = setTimeout(() => {
      playStep();
      scheduleNextStep();
    }, (nextStepTime - audioContext.currentTime) * 1000);
  }

  function playStep() {
    const currentBar = Math.floor(beatCount / 4) + 1; // Calculate the current bar

    channels.forEach((channel, index) => {
        const buttons = channel.querySelectorAll('.step-button');
        let isMuted = channel.dataset.muted === 'true';

        // Unmute the channel at the designated bar if it's currently muted
        if (isMuted && presets.preset1.unmuteBars[index] === currentBar) {
            channel.dataset.muted = 'false';
            isMuted = false;
            channel.querySelector('.mute-button').classList.remove('selected'); // Reflect the state change in the UI
        }

        if (buttons[currentStep]) {
            buttons.forEach(button => button.classList.remove('playing'));
            buttons[currentStep].classList.add('playing');
        }

        if (buttons[currentStep].classList.contains('selected') && !isMuted) {
            const audioData = channel.dataset.audioData;
            if (audioData) {
                const audio = new Audio(audioData);
                const source = audioContext.createMediaElementSource(audio);
                source.connect(audioContext.destination);
                audio.play();
            }
        }
    });

    currentStep = (currentStep + 1) % 64;
    beatCount++;  // increase the bar count
    nextStepTime += stepDuration;
}

  function stopScheduler() {
    if (audioContext) {
      audioContext.close();
    }
    clearTimeout(timeoutId);
  }

  function resetStepLights() {
    const buttons = document.querySelectorAll('.step-button');
    buttons.forEach(button => {
        button.classList.remove('playing');
    });
    }

  function togglePlayState(isPlaying, startStopFunction, firstButton, secondButton) {
    if (!isPlaying) {
      isPlaying = true;
      startStopFunction();
      firstButton.classList.add('selected');
      secondButton.classList.remove('selected');
    }
  }
</script>
</body>
</html>
    
